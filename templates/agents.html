<div x-data="alpineAgents()" x-init="initPage()">

    <!-- PAGE HEADER -->

    <div>
        <h2>Agents</h2>
        <p>
            You must deploy at least 1 agent in order to run an operation. Groups are collections of agents so hosts can be compromised simultaneously.
        </p>
    </div>
    <hr>

    <!-- AGENTS TABLE AND CONFIGURATION -->

    <div>
        <div class="buttons">
            <button class="button is-primary" @click="showDeployModal = true">
                <span class="icon"><i class="far fa-plus-square"></i></span>
                <span>Deploy an agent</span>
            </button>
        </div>
        <table class="table is-striped is-fullwidth" x-show="agents.length">
            <thead>
                <tr>
                    <td><b>id (paw)</b></td>
                    <td><b>host</b></td>
                    <td><b>contact</b></td>
                    <td><b>pid</b></td>
                    <td><b>privilege</b></td>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                <template x-for="agent of agents">
                    <tr x-init="console.log(agent)">
                        <td x-text="agent.paw"></td>
                        <td x-text="agent.host"></td>
                        <td x-text="agent.contact"></td>
                       
                        <td><button x-text="agent.pid" class="" @click="showAgentInfo(agent.paw)"></button></td>
                        <td x-text="agent.privilege"></td>
                        <td class="has-text-centered"><button class="delete is-danger" @click="removeAgent(agent.paw)"></button></td>
                    </tr>
                </template>
            </tbody>
        </table>
        <div class="has-text-centered content" x-show="!agents.length">
           <p>You have no deployed agents.</p> 
        </div>
        <div class="content">
            <h3>Configuration</h3>
        </div>
    </div>

    <!-- MODALS -->

    <div class="modal" x-bind:class="{ 'is-active': showDeployModal }">
        <div class="modal-background" @click="showDeployModal = false"></div>
        <div class="modal-card wide">
            <header class="modal-card-head">
                <p class="modal-card-title">Deploy an agent</p>
            </header>
            <section class="modal-card-body">
                <form class="has-text-centered">
                    <div class="field">
                        <label class="label">Agent</label>
                        <div class="control">
                            <div class="select is-small">
                                <select x-model="selectedAbilityId" x-on:change="selectAbility()">
                                    <option disabled selected value="">Choose an agent</option>
                                    <template x-for="ability of abilities" :key="ability.ability_id">
                                        <option x-bind:value="ability.ability_id" x-text="`${ability.name} | ${ability.description}`"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Platform</label>
                        <div class="control is-flex is-flex-direction-row is-justify-content-center">
                            <div class="has-text-centered platform" x-bind:class="{ 'selected': !selectedPlatform }" @click="changePlatform('')">
                                <span class="icon is-large"><i class="far fa-2x fa-circle"></i></span>
                                <br> all 
                            </div>
                            <div class="has-text-centered platform" x-bind:class="{ 'selected': selectedPlatform === 'linux' }" x-show="platforms.includes('linux')" @click="changePlatform('linux')">
                                <span class="icon is-large"><i class="fab fa-2x fa-linux"></i></span>
                                <br> linux 
                            </div>
                            <div class="has-text-centered platform" x-bind:class="{ 'selected': selectedPlatform === 'windows' }" x-show="platforms.includes('windows')" @click="changePlatform('windows')">
                                <span class="icon is-large"><i class="fab fa-2x fa-windows"></i></span>
                                <br> windows 
                            </div>
                            <div class="has-text-centered platform" x-bind:class="{ 'selected': selectedPlatform === 'darwin' }" x-show="platforms.includes('darwin')" @click="changePlatform('darwin')">
                                <span class="icon is-large"><i class="fab fa-2x fa-apple"></i></span>
                                <br> darwin 
                            </div>
                        </div>
                    </div>
                </form>
                <form class="command-fields has-text-centered">
                    <template x-for="field of agentFields" :key="field.name">
                        <div class="field is-horizontal">
                            <div class="field-label is-normal">
                                <label class="label" x-text="field.name"></label>
                            </div>
                            <div class="field-body">
                                <div class="field has-addons">
                                    <div class="control is-expanded">
                                        <input class="input is-small" type="text" x-model="field.value">
                                    </div>
                                    <div class="control">
                                        <a class="button is-small has-tooltip-arrow" data-tooltip="Reset to default" @click="field.value = agentConfig[field.name]">
                                            <span class="icon"><i class="fas fa-undo"></i></span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </form>
                <hr x-show="filteredCommands.length">
                <div>
                    <template x-for="command of filteredCommands" :key="command.command">
                        <div class="command-container container">
                            <div class="tags are-medium has-addons">
                                <span class="tag is-black">
                                    <span class="icon">
                                        <i class="fab" x-bind:class="{ 'fa-windows': command.platform === 'windows', 'fa-linux': command.platform === 'linux', 'fa-apple': command.platform === 'darwin' }"></i>
                                    </span>
                                </span>
                                <span class="tag is-dark" x-text="command.executor"></span>
                                <span class="tag" x-text="command.description"></span>
                            </div>
                            <div class="box container">
                                <pre class="box" x-text="getCommandField(command.command)"></pre>
                                <a class="button is-small is-outlined copy-button" @click="copyCommandToClipboard(getCommandField(command.command))">
                                    <span class="icon"><i class="far fa-lg fa-copy"></i></span>
                                    <span>Copy</span>
                                </a>
                            </div>
                            <p class="has-text-centered" x-show="command.variations.length"><b>Variations</b></p>
                            <template x-for="variation of command.variations" :key="variation.command">
                                <div class="content">
                                    <p x-text="variation.description"></p>
                                    <div class="box container">
                                        <pre class="box" x-text="getCommandField(variation.command).replaceAll(';', ';\n')"></pre>
                                        <a class="button is-small is-outlined copy-button" @click="copyCommandToClipboard(getCommandField(variation.command))">
                                            <span class="icon"><i class="far fa-lg fa-copy"></i></span>
                                            <span>Copy</span>
                                        </a>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-small" @click="showDeployModal = false">Done</button>
            </footer>
        </div>
    </div>


</div>

<script>
    let abilitiesOld = {{ abilities | tojson }}

     function alpineAgents() {
        return {
            // Core variables
            agents: [],
            abilities: [],
            selectedAbilityId: '',
            selectedAbility: {},
            platforms: [],
            selectedPlatform: '',

            agentConfig: {},
            agentFields: [],
            deployCommands: [],
            filteredCommands: [],

            // Modals
            showDeployModal: false,

            initPage() {
                apiV2('GET', '/api/v2/agents').then((agents) => {
                    this.agents = agents;
                    return apiV2('GET', '/api/v2/config/agents');
                }).then((agentConfig) => {
                    this.abilities = [];
                    Object.keys(abilitiesOld).forEach((abilityId) => {
                        this.abilities.push(abilitiesOld[abilityId][0])
                    });
                }).catch((error) => {
                    toast('Error initializing page, see console for details.', false);
                    console.error(`Error initializing page: ${error}`);
                })
            },

            selectAbility() {
                this.selectedAbility = this.abilities.find((ability) => ability.ability_id === this.selectedAbilityId);
                this.platforms = [...new Set(this.selectedAbility.executors.map((executor) => executor.platform))];
                if (!this.platforms.includes(this.selectedPlatform)) this.selectedPlatform = '';

                apiV2('GET', `/api/v2/deploy_commands/${this.selectedAbilityId}`).then((data) => {
                    this.deployCommands = data.abilities;
                    this.agentConfig = data.app_config;
                    this.filterAbilityPlatforms();
                }).catch((error) => {
                    toast('Error loading the agent.', false);
                    console.error(`Error loading the agent: ${error}`);
                });
            },

            changePlatform(platform) {
                this.selectedPlatform = platform;
                this.filterAbilityPlatforms();
            },

            filterAbilityPlatforms() {
                if (!this.selectedPlatform) {
                    this.filteredCommands = this.deployCommands;
                } else {
                    this.filteredCommands = this.deployCommands.filter((ability) => ability.platform === this.selectedPlatform);
                }

                let fields = [];
                this.agentFields = [];
                this.filteredCommands.forEach((command) => {
                    fields = fields.concat([...command.command.matchAll(/#{(.*?)}/gm)].map((field) => field[1]));
                });
                fields = [...new Set(fields)];
                fields.forEach((field) => {
                    this.agentFields.push({ name: field, value: this.agentConfig[field] });
                });
            },

            getCommandField(command) {
                this.agentFields.forEach((field) => { 
                    command = command.replaceAll(`#{${field.name}}`, field.value)
                });
                return command;
            },

            copyCommandToClipboard(command) {
                navigator.clipboard.writeText(command);
                toast('Copied command to clipboard!', true);
            },

            showAgentInfo(paw) {
                
            },

            removeAgent(paw) {

            }
        };
    }

    // # sourceURL=agents.js
</script>

<style>

    pre {
        margin-bottom: 10px;
    }
    pre.box {
        margin-bottom: 0;
        margin-top: 10px;
    }

    .command-container {
        background-color: #262626;
        border-radius: 4px;
        margin: 30px;
    }

    .command-fields {
        padding: 0 250px;
    }

    .copy-button {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .platform {
        width: 80px;
        border-radius: 4px;
        padding: 5px;
        margin: 5px;
        font-family: monospace;
        border: 1px solid transparent;
    }
    .platform:hover {
        background-color: #484848;
        cursor: pointer; 
    }
    .platform.selected {
        border: 1px solid white;
    }

</style>
