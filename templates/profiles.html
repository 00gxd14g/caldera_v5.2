<div x-data="alpineAdversaries()">
    <div>
        <h2>Adversary Profiles</h2>
        <p>
            Adversary Profiles are collections of ATT&CK TTPs, designed to create specific effects on a host or network.
            Profiles can be used for offensive or defensive use cases.
        </p>
    </div>
    <hr>
    <form>
        <div class="field is-horizontal">
            <div class="field-label is-normal">
                <label class="label">Select a profile</label>
            </div>
            <div class="field-body">
                <div class="field is-grouped">
                    <label class="label"></label>
                    <div class="control is-expanded">
                        <div class="select">
                            <select x-on:change="loadProfile()" x-model="selectedProfile">
                                <option value="" default selected>Chose one...</option>
                                {% for adv in adversaries %}
                                <option id="adversary-{{ adv.adversary_id}}" value="{{ adv.adversary_id }}">{{ adv.name }}</option>
                                <option disabled class="has-text-grey-lighter is-italic">&nbsp;&nbsp;&nbsp;{{ adv.description }}</option> 
                                {% endfor %}}
                            </select>
                        </div>
                    </div>
                    <p class="control">
                        <a class="button is-primary" @click="isCreatingProfile = true">
                            <span class="icon"><i class="far fa-plus-square"></i></span>
                            <span>Create a profile</span>
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </form>
    <template x-if="selectedProfile && !isCreatingProfile">
        <div class="section">
            <div x-show="!isEdittingProfile">
                <h3 x-text="selectedProfileName" class="pointer tooltip has-tooltip-arrow" data-tooltip="Click to edit" @click="isEdittingProfile = true"></h3>
                <p x-text="selectedProfileDescription" class="pointer" @click="isEdittingProfile = true"></p> <br>
            </div>
            <form x-show="isEdittingProfile">
                <div class="field">
                    <div class="control">
                        <input class="input" x-model="selectedProfileName" x-on:change="unsavedChanges = true" placeholder="Adversary Name">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <input class="input is-small" x-model="selectedProfileDescription" placeholder="Adversary Description" x-on:change="unsavedChanges = true">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <a class="button is-small is-primary" @click="isEdittingProfile = false">Done</a>
                    </div>
                </div>
            </form>
            <div class="control-buttons is-flex is-flex-direction-row">
                <button class="button is-small" @click="showAbilityModal = true">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Add Ability</span>
                </button>
                <button class="button is-small" @click="showAddAdversaryModal = true">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Add Adversary</span>
                </button>
                <div class="vr"></div>
                <span>Objective: <b x-text="selectedObjective.name"></b>&nbsp;&nbsp;&nbsp;</span>
                <button class="button is-small" @click="showObjectiveModal = true">Change</button>
                <div class="vr"></div>
                <button class="button is-success is-small" x-bind:disabled="!unsavedChanges" @click="saveProfile()">Save Profile</button>
                <button class="button is-danger is-outlined is-small" @click="deleteProfile()">Delete Profile</button>
            </div>
            <div class="is-flex is-flex-direction-row is-flex-wrap-wrap">
                <template x-for="(ability, index) in abilities">
                    <div x-on:dragover.prevent="swapAbilities(index)" @click="selectAbility(ability.ability_id)">
                        <article class="media ability" draggable="true" x-on:dragstart="startAbilitySwap(index)">
                            <div class="media-content">
                                <div class="is-flex is-flex-direction-row">
                                    <p class="ability-number has-text-centered" x-text="index + 1"></p>
                                    <p class="ability-content">
                                        <strong x-text="ability.name"></strong>
                                        <br>
                                        <span x-text="ability.tactic"></span>
                                        <br>
                                        <span x-text="ability.technique_name"></span>
                                    </p>
                                </div>
                                <nav class="level is-mobile">
                                    <div class="level-left">
                                        <template x-for="platform of getExecutorDetail('platforms', ability)">
                                            <a class="level-item has-tooltip-arrow" x-bind:data-tooltip="platform">
                                                <span class="icon is-small"><i class="fab" x-bind:class="if (platform.includes('windows')) return 'fa-windows'; else if (platform.includes('darwin')) return 'fa-apple'; else if (platform.includes('linux')) return 'fa-linux'"></i></span>
                                            </a>
                                        </template>
                                    </div>
                                    <div class="level-right">
                                        <a class="level-item has-tooltip-arrow" x-show="getExecutorDetail('requirements', ability)" data-tooltip="This ability has requirements">
                                            <span class="icon is-small"><i class="fas fa-lock"></i></span>
                                        </a>
                                        <a class="level-item has-tooltip-arrow" x-show="getExecutorDetail('cleanup', ability)" data-tooltip="This ability can clean itself up">
                                            <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                        </a>
                                        <a class="level-item has-tooltip-arrow" x-show="getExecutorDetail('parser', ability)" data-tooltip="This ability unlocks other abilities">
                                            <span class="icon is-small"><i class="fas fa-key"></i></span>
                                        </a>
                                        <a class="level-item has-tooltip-arrow" x-show="getExecutorDetail('payload', ability)" data-tooltip="This ability uses a payload">
                                            <span class="icon is-small"><i class="fas fa-weight-hanging"></i></span>
                                        </a> 
                                    </div>
                                </nav>
                            </div>
                            <div class="media-right">
                                <button class="delete is-danger" @click="removeAbility(index)"></button>
                            </div>
                        </article>
                    </div>
                </template>
            </div>
        </div>
    </template>
    <template x-if="isCreatingProfile">
        <div class="section content">
            <h3>Create a profile</h3>
            <form>
                <div class="field">
                    <label class="label">Profile Name</label>
                    <div class="control">
                        <input x-model="createProfileName" class="input" type="text" placeholder="Enter a name...">
                    </div>
                    <p class="help is-danger has-text-weight-bold" x-show="createProfileNameError" x-text="createProfileNameError"></p>
                </div>
                <div class="field">
                    <label class="label">Profile Description</label>
                    <div class="control">
                        <input x-model="createProfileDescription" class="input" type="text" placeholder="Enter a description...">
                    </div>
                    <p class="help is-danger has-text-weight-bold" x-show="createProfileDescriptionError" x-text="createProfileDescriptionError"></p>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" @click="createProfile()">Create</button>
                    </div>
                    <div class="control">
                        <button class="button is-light is-outlined" @click="cancelCreateProfile()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </template>

    <div class="modal" x-bind:class="{ 'is-active': showAddAdversaryModal }">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Add Ablities from Adversary</p>
            </header>
            <section class="modal-card-body">
                <p>Select an adversary, then select all of the abilities you'd like to append to <b x-text="selectedProfileName"></b>.</p>
                <form>
                    <div class="field">
                        <label class="label">Select a profile</label>
                        <div class="control is-expanded">
                            <div class="select">
                                <select x-on:change="loadProfileAdversary()" x-model="selectedAddAdversary">
                                    <option value="" default selected>Chose one...</option>
                                    {% for adv in adversaries %}
                                    <option value="{{ adv.adversary_id }}">{{ adv.name }}</option>
                                    <option disabled style="font-style:italic">&nbsp;&nbsp;&nbsp;{{ adv.description }}</option> 
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field" x-show="selectedAddAdversary">
                        <div class="control">
                            <a @click="abilitiesAddAdversary.forEach(a => a.selected = true)">Select All</a> 
                            / 
                            <a @click="abilitiesAddAdversary.forEach(a => a.selected = false)">Deselect All</a>
                        </div>
                    </div>
                    <template x-for="ability of abilitiesAddAdversary">
                        <div class="field">
                            <label class="checkbox">
                                <input type="checkbox" x-model="ability.selected"> 
                                <span>
                                    <b x-text="ability.name"></b> | 
                                    <span x-text="ability.tactic"></span> |
                                    <template x-for="platform of getExecutorDetail('platforms', ability)">
                                        <span class="icon is-small"><i class="fab" x-bind:class="if (platform.includes('windows')) return 'fa-windows'; else if (platform.includes('darwin')) return 'fa-apple'; else if (platform.includes('linux')) return 'fa-linux'"></i></span>
                                    </template> |
                                    <span class="icon is-small" x-show="getExecutorDetail('requirements', ability)"><i class="fas fa-lock"></i></span>
                                    <span class="icon is-small" x-show="getExecutorDetail('cleanup', ability)"><i class="fas fa-trash"></i></span>
                                    <span class="icon is-small" x-show="getExecutorDetail('parser', ability)"><i class="fas fa-key"></i></span>
                                    <span class="icon is-small" x-show="getExecutorDetail('payload', ability)"><i class="fas fa-weight-hanging"></i></span>
                                </span>
                            </label>
                        </div>
                    </template>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary is-small" x-bind:disabled="!abilitiesAddAdversary.find(a => a.selected)" @click="addAbilitiesFromAdversary()">Add Selected Abilities</button>
                <button class="button is-small" @click="showAddAdversaryModal = false; selectedAddAdversary = ''; abilitiesAddAdversary = [];">Cancel</button>
            </footer>
        </div>
    </div>

    <div class="modal" x-bind:class="{ 'is-active': showObjectiveModal }">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Link Objective</p>
            </header>
            <section class="modal-card-body">
                <p>Specify an Objective for <b x-text="selectedProfileName"></b>.</p>
                <form>
                    <div class="field">
                        <label class="label">Select an objective</label>
                        <div class="control is-expanded">
                            <div class="select">
                                <select x-model="selectedObjective.id">
                                    <option value="" default selected>Chose one...</option>
                                    {% for obj in objectives %}
                                    <option value="{{ obj.id }}">{{ obj.name }}</option>
                                    <option disabled style="font-style:italic">&nbsp;&nbsp;&nbsp;{{ obj.description }}</option> 
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary is-small" @click="toast('Objective changed', true); showObjectiveModal = false;">Link Objective</button>
                <button class="button is-small" @click="showObjectiveModal = false">Cancel</button>
            </footer>
        </div>
    </div>

    <div class="modal" x-bind:class="{ 'is-active': showAbilityModal }" x-init="initExploits()"> 
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Add an Ability to Adversary</p>
            </header>
            <section class="modal-card-body">
                <p class="has-text-centered">Select an Ability</p>
                <form>
                    <div class="field is-horizontal">
                        <div class="field-label is-small">
                             <label class="label">Tactic</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select x-model="selectedTactic" x-on:change="filterTechniques()">
                                            <option default>Choose a tactic</option>
                                            <template x-for="tactic of Object.keys(abilitiesObject)">
                                                <option x-bind:value="tactic" x-text="tactic"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-small">
                             <label class="label">Technique</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select x-model="selectedTechnique" x-bind:disabled="!selectedTactic" x-on:change="filterAbilities()">
                                            <option default>Choose a technique</option>
                                            <template x-for="technique of techniques">
                                                <option x-bind:value="technique" x-text="`${technique} | ${abilitiesObject[selectedTactic][technique].name}`"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal is-fullwidth">
                        <div class="field-label is-small">
                             <label class="label">Ability</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select x-model="selectedAbilityId" x-bind:disabled="!selectedTechnique" x-on:change="selectAbility(selectedAbilityId)">
                                            <option default>Choose an ability</option>
                                            <template x-for="ability of abilitiesAddModal">
                                                <option x-bind:value="ability.id" x-text="ability.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <template x-if="selectedAbility && selectedAbility.ability_id">
                    <div class="content">
                        <hr>
                        <p class="has-text-centered">Ability Details</p>
                        <form>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">ID</label>
                                </div>
                                <div class="field-body">
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <input class="input is-small" x-model="selectedAbility.ability_id" disabled>
                                        </div>
                                        <div class="control">
                                            <a class="button is-small has-tooltip-left has-tooltip-arrow" data-tooltip="Generate New ID" @click="selectedAbility.ability_id = uuidv4()">
                                                <span class="icon is-small"><i class="fas fa-sync"></i></span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Name</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.name">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Description</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.description">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Tactic</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.tactic">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label is-small">Technique ID</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.technique_id">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Technique Name</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.technique_name">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </template>
                <template x-if="selectedAbilityExecutors">
                    <div>
                        <p class="has-text-centered">Executors</p>
                        <template x-for="(executor, index) of selectedAbilityExecutors">
                            <div class="box">
                                <div class="has-text-right">
                                    <button class="delete" @click="selectedAbilityExecutors.splice(index, 1)"></button>
                                </div>
                                <form>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">platform</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <div class="select is-small">
                                                        <select x-model="selectedAbilityExecutors[index].platform">
                                                            {% for platform, executors in platforms.items() %}
                                                            <option value="{{ platform }}">{{ platform }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">executor</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <div class="select is-small">
                                                        <select x-model="selectedAbilityExecutors[index].name">
                                                            <template x-for="executor of platforms[selectedAbilityExecutors[index].platform]">
                                                                <option x-bind:value="executor" x-text="executor"></option>
                                                            </template>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">payloads</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field is-grouped is-grouped-multiline">
                                                <p x-show="selectedAbilityExecutors[index].payloads.length === 0" class="help">No payloads selected</p>
                                                <template x-for="(payload, index) of selectedAbilityExecutors[index].payloads">
                                                    <div class="control">
                                                        <div class="tags has-addons">
                                                            <span class="tag is-small is-link" x-text="payload"></span>
                                                            <a class="tag is-delete" x-on:click="selectedAbilityExecutors[index].payloads.splice(index, 1)"></a>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label"></label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field">
                                                <div class="control">
                                                    <div class="select is-small is-multiple is-fullwidth">
                                                        <select class="select" multiple size="6">
                                                            <template x-for="payload of payloads">
                                                                <option x-show="selectedAbilityExecutors[index].payloads.indexOf(payload) === -1" x-on:click="selectedAbilityExecutors[index].payloads.push(payload)" x-text="payload"></option>
                                                            </template>      
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">command</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <textarea class="textarea is-small code" x-model="executor.command"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">timeout</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <input class="input is-small" type="number" x-model="executor.timeout">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">cleanup</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <input class="input is-small code" x-model="executor.cleanup">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </template>
                        <div class="has-text-centered">
                            <button class="button is-small is-primary" @click="selectedAbilityExecutors.push([])">+ Add Executor</button>
                        </div>
                </template>
            </section>
            <footer class="modal-card-foot">
                <nav class="level">
                    <div class="level-left">
                        <div class="level-item" x-show="selectedAbility">
                            <button class="button is-primary is-small" @click="saveAbility(false)">Save</button>
                        </div>
                        <div class="level-item" x-show="selectedAbility">
                            <button class="button is-primary is-small" @click="saveAbility(true)">Save and Add to Adversary</button>
                        </div>
                    </div>
                    <div class="level-right">
                        <p class="level-item">
                            <button class="button is-small" @click="closeAbilityModal()">Close</button>
                        </p>
                    </div>
                </nav>
            </footer>
        </div>
    </div>
</div>

<script>
    let adversaries = {{ adversaries | tojson }};
    let objectives = {{ objectives | tojson }};
    let exploits = {{ exploits | tojson }};
    let platforms = {{ platforms | tojson }};
    let payloads = {{ payloads | tojson }};

    function alpineAdversaries() {
        return {
            selectedProfile: '',
            selectedProfileName: '',
            selectedProfileDescription: '',
            abilities: [],
            objectives: [],

            isEdittingProfile: false,
            isCreatingProfile: false,
            createProfileNameError: false,
            createProfileDescriptionError: false,
            createProfileName: '',
            createProfileDescription: '',

            dragAbilityIndex: -1,
            dragNew: false,

            unsavedChanges: false,

            showAddAdversaryModal: false,
            selectedAddAdversary: '',
            abilitiesAddAdversary: [],

            showObjectiveModal: false,
            selectedObjective: {},

            showAbilityModal: false,
            selectedTactic: '',
            selectedTechnique: '',
            selectedAbilityId: '',
            selectedAbility: null,
            selectedAbilityExecutors: [],
            selectedPlatform: '',
            selectedExecutor: '',
            abilitiesObject: {},
            techniques: [],
            abilitiesAddModal: [],

            getExecutorDetail(detail, ability) {
                let executorNameMap = new Map([
                    ['psh', 'powershell'],
                    ['pwsh', 'powershell core'],
                    ['sh', 'shell'],
                    ['cmd', 'commandline'],
                ]);
                let platforms = [], hasCleanup = false, hasPayload = false, hasParser = false;

                ability.executors.forEach((executor) => {
                    if (executor.cleanup.length > 0) hasCleanup = true;
                    if (executor.parsers.length > 0) hasParser = true;
                    if (executor.payloads.length > 0) hasPayload = true;
                    platforms.push(`${executor.platform} (${executorNameMap.get(executor.name) || executor.name})`);
                });

                switch (detail) {
                    case 'cleanup':
                        return hasCleanup;
                    case 'parser':
                        return hasParser;
                    case 'payload':
                        return hasPayload;
                    case 'requirements':
                        return ability.requirements.length > 0;
                    case 'platforms':
                        return platforms;
                    default:
                        return false;
                }
            },

            loadProfile() {
                if (!this.selectedProfile) return;

                this.abilities = [];
                this.isCreatingProfile = false;

                apiRequest('POST', { 'index': 'adversaries', 'adversary_id': this.selectedProfile }).then((data) => {
                    data = JSON.parse(data)[0]

                    this.selectedProfileName = data.name;
                    this.selectedProfileDescription = data.description;
                    this.selectedObjective = data.objective;
                    
                    this.abilities = data.atomic_ordering;
                }).catch((error) => {
                    toast('Error loading profile', false);
                    console.error(error);
                });
            },

            loadProfileAdversary() {
                if (!this.selectedAddAdversary) return;

                this.abilitiesAddAdversary = [];

                apiRequest('POST', { 'index': 'adversaries', 'adversary_id': this.selectedAddAdversary }).then((data) => {
                    data = JSON.parse(data)[0]
                    
                    data.atomic_ordering.forEach((ability) => {
                        this.abilitiesAddAdversary.push({
                            ...ability,
                            selected: true
                        });
                    });
                }).catch((error) => {
                    toast('Error loading adversary profile', false);
                    console.error(error);
                });
            },

            createProfile() {
                // Verify user input
                this.createProfileNameError = '';
                this.createProfileDescriptionError = '';
                if (this.createProfileName.length === 0) {
                    this.createProfileNameError = 'You must enter a profile name';
                    return;
                } else if (adversaries.map(a => a.name).indexOf(this.createProfileName) > -1) {
                    this.createProfileNameError = 'Profile name already exists';
                    return;
                } else if (this.createProfileDescription.length === 0) {
                    this.createProfileDescriptionError = 'You must enter a profile description';
                    return;
                }

                let requestBody = {
                    "name": this.createProfileName,
                    "description": this.createProfileDescription,
                    "atomic_ordering": [],
                    "index": "adversaries",
                    'id': uuidv4(),
                    "objective": objectives.find((o) => o.name === 'default').id
                }

                apiRequest('PUT', requestBody).then((data) => {
                    data = JSON.parse(data)[0]
                    adversaries.push(data);
                    this.selectedProfile = data.adversary_id;
                    this.loadProfile();
                    this.isCreatingProfile = false;
                    toast('Created profile!', true);
                }).catch((error) => {
                    toast('Error creating profile', false);
                    console.error(error);
                });
            },

            cancelCreateProfile() {
                this.createProfileName = '';
                this.createProfileDescription = '';
                this.isCreatingProfile = false;
            },

            saveProfile() {
                let atomicOrdering = [];
                this.abilities.forEach((a) => atomicOrdering.push({ 'id': a.ability_id }));

                let requestBody = {
                    "name": this.selectedProfileName,
                    "description": this.selectedProfileDescription,
                    "atomic_ordering": atomicOrdering,
                    "index": "adversaries",
                    "id": this.selectedProfile,
                    "objective": "495a9828-cab1-44dd-a0ca-66e58177d8cc"
                }

                apiRequest('PUT', requestBody).then((data) => {
                    this.unsavedChanges = false;
                    toast('Saved profile!', true);
                }).catch((error) => {
                    toast('Error saving profile', false);
                    console.error(error);
                });
            },

            deleteProfile() {
                if (confirm('Are you sure you want to remove this adversary?')) {
                    apiRequest('DELETE', { 'index': 'adversaries', 'adversary_id': this.selectedProfile }).then((data) => {
                        adversaries.splice(adversaries.findIndex(a => a.adversary_id === this.selectedProfile), 1);
                        this.selectedProfile = null;
                        toast('Adversary profile deleted.', true);
                    }).catch((error => {
                        toast('Error deleting profile', false);
                        console.error(error);
                    }));
                }
            },

            addAbilitiesFromAdversary() {
                let selectedAbilities = this.abilitiesAddAdversary.filter((a) => a.selected);
                this.abilities = this.abilities.concat(selectedAbilities);
                this.showAddAdversaryModal = false;
                this.selectedAddAdversary = '';
                this.abilitiesAddAdversary = [];
                this.unsavedChanges = true;
            },

            selectAbility(id) {
                this.selectedAbility = exploits.find((exploit) => exploit.ability_id === id);
                this.selectedAbilityExecutors = this.selectedAbilityExecutors;
                this.selectedTactic = this.selectedAbility.tactic;
                this.filterTechniques();
                this.selectedTechnique = this.selectedAbility.technique_id;
                this.filterAbilities();
                this.selectedAbilityId = id;
                this.showAbilityModal = true;
            },

            saveAbility(addToAdversary) {
                let platforms = {};
                this.selectedAbilityExecutors.forEach((executor) => {
                    if (!platforms[executor.platform]) {
                        platforms[executor.platform] = {}
                    }

                    platforms[executor.platform][executor.name] = {
                        'payloads': [...executor.payloads],
                        'command': executor.command.toString(),
                        'timeout': executor.timeout.toString(),
                        'cleanup': executor.cleanup.toString()
                    }
                });

                let requestBody = {
                    'index': 'abilities',
                    'id': this.selectedAbility.ability_id,
                    'name': this.selectedAbility.name,
                    'description': this.selectedAbility.description,
                    'tactic': this.selectedAbility.tactic,
                    'technique': {
                        'attack_id': this.selectedAbility.technique_id,
                        'name': this.selectedAbility.technique_name
                    },
                    'platforms': platforms
                }
                
                apiRequest('PUT', requestBody).then((response) => {
                    toast('Saved ability!', true);

                    if (addToAdversary) {
                        this.abilities.push(this.selectedAbility);
                        this.unsavedChanges = true;
                    }
                }).catch((error) => {
                    toast('Error saving ability', false);
                    console.error(error);
                });
            },

            removeAbility(index) {
                this.abilities.splice(index, 1);
                this.unsavedChanges = true;
            },
            
            closeAbilityModal() {
                this.showAbilityModal = false; 
                this.selectedAbilityId = '';
                this.selectedAbility = {};
                this.selectedAbilityExecutors = [];
            },

            initExploits() {
                exploits.forEach((exploit) => {
                    if (!this.abilitiesObject[exploit.tactic]) {
                        this.abilitiesObject[exploit.tactic] = {};
                    }
                    if (!this.abilitiesObject[exploit.tactic][exploit.technique_id]) {
                        this.abilitiesObject[exploit.tactic][exploit.technique_id] = { name: exploit.technique_name };
                    }
                    if (!this.abilitiesObject[exploit.tactic][exploit.technique_id].abilites) {
                        this.abilitiesObject[exploit.tactic][exploit.technique_id].abilites = [];
                    }

                    this.abilitiesObject[exploit.tactic][exploit.technique_id].abilites.push({
                        id: exploit.ability_id,
                        name: exploit.name
                    });
                });
            },

            filterTechniques() {
                if (!this.selectedTactic) return this.techniques = [];
                this.techniques = Object.keys(this.abilitiesObject[this.selectedTactic]);
            },

            filterAbilities() {
                this.abilitiesAddModal = this.abilitiesObject[this.selectedTactic][this.selectedTechnique].abilites;
            },

            startAbilitySwap(index) {
                this.dragAbilityIndex = index; 
                this.dragNew = true;
            },

            swapAbilities(to) {
                if (!this.dragNew || this.dragAbilityIndex === to) return;

                let temp = this.abilities[to];
                this.abilities[to] = this.abilities[this.dragAbilityIndex];
                this.abilities[this.dragAbilityIndex] = temp;
                this.dragNew = false;
                this.unsavedChanges = true;
            },

        };
    }

    // # sourceURL=adversaries.js
</script>

<style>
    .ability {
        width: 350px;
        border: 1px solid white !important;
        border-radius: 4px;
        padding: 10px;
        margin: 0 10px 10px 0;
    }

    .ability>.media-content {
        width: 90%;
    }

    .ability-content {
        width: 100%;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }
    
    .ability-number {
        width: 40px;
        border-right: 1px solid white;
        padding-right: 10px;
        margin-right: 10px;
        font-size: 2em ;
        margin-bottom: 0 !important;
    }

    .code {
        font-family: monospace;
    }

    .control-buttons>.button {
        margin: 0 10px 10px 0;
    }

    .level {
        width: 100%;
    }

    .media + .media {
        margin-top: 0;
    }

    .pointer {
        cursor: pointer;
    }

    .vr {
        width: 1px;
        height: 30px;
        margin: 0 20px 0 10px;
        background-color: grey;
    }
</style>
