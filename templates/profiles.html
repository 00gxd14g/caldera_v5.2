<div x-data="alpineAdversaries()">

    <!-- PAGE DETAILS -->

    <div>
        <h2>Adversary Profiles</h2>
        <p>
            Adversary Profiles are collections of ATT&CK TTPs, designed to create specific effects on a host or network.
            Profiles can be used for offensive or defensive use cases.
        </p>
    </div>
    <hr>

    <!-- ADVERSARY SELECTION -->

    <form>
        <div id="select-adversary" class="field has-addons">
            <label class="label">Select a profile &nbsp;&nbsp;&nbsp;</label>
            <div class="control is-expanded">
                <div class="select is-small is-fullwidth">
                    <select x-on:change="loadProfile()" x-model="selectedProfile">
                        <option value="" default selected>Chose one...</option>
                        {% for adv in adversaries %}
                        <option id="adversary-{{ adv.adversary_id}}" value="{{ adv.adversary_id }}">{{ adv.name }}</option>
                        <option disabled class="has-text-grey-lighter is-italic">&nbsp;&nbsp;&nbsp;{{ adv.description }}</option> 
                        {% endfor %}}
                    </select>
                </div>
            </div>
            <div class="control">
                <button type="button" class="button is-primary is-small" @click="isCreatingProfile = true">+ New</button>
            </div>
        </div>
    </form>

    <!-- ADVERSARY DETAILS -->

    <template x-if="selectedProfile && !isCreatingProfile">
        <div class="section" x-init="$watch('abilities', val => findAbilityDependencies())">
            <div x-show="!isEdittingProfile">
                <h3 x-text="selectedProfileName" class="pointer tooltip has-tooltip-arrow" data-tooltip="Click to edit" @click="isEdittingProfile = true"></h3>
                <p x-text="selectedProfileDescription" class="pointer" @click="isEdittingProfile = true"></p> <br>
            </div>
            <form x-show="isEdittingProfile">
                <div class="field">
                    <div class="control">
                        <input class="input" x-model="selectedProfileName" x-on:change="unsavedChanges = true" placeholder="Adversary Name">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <input class="input is-small" x-model="selectedProfileDescription" placeholder="Adversary Description" x-on:change="unsavedChanges = true">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <a class="button is-small is-primary" @click="isEdittingProfile = false">Done</a>
                    </div>
                </div>
            </form>
            <div class="control-buttons is-flex is-flex-direction-row">
                <button class="button is-small" @click="selectedAbilityId = ''; showAbilityModal = true;">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Add Ability</span>
                </button>
                <button class="button is-small" @click="showAddAdversaryModal = true">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Add Adversary</span>
                </button>
                <div class="vr"></div>
                <span>Objective: <b x-text="selectedObjective.name"></b>&nbsp;&nbsp;&nbsp;</span>
                <button class="button is-small" @click="showObjectiveModal = true">Change</button>
                <div class="vr"></div>
                <button class="button is-success is-small" x-bind:disabled="!unsavedChanges" @click="saveProfile()">Save Profile</button>
                <button class="button is-danger is-outlined is-small" @click="deleteProfile()">Delete Profile</button>
            </div>
            <template x-if="abilities.length">
                <table class="table is-striped is-fullwidth">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Ordering</th>
                            <th>Name</th>
                            <th>Tactic</th>
                            <th>Technique</th>
                            <th>Platforms</th>
                            <th>Requires</th>
                            <th>Unlocks</th>
                            <th>Payload</th>
                            <th>Cleanup</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(ability, index) in abilities">
                            <tr @click="selectAbility(ability.ability_id)" x-bind:class="{ 'red-row': needsParser.indexOf(ability.name) > -1, 'row-hover': ability.ability_id === abilityTableDragHoverId }" x-on:mouseenter="setAbilityHover(ability.ability_id)" x-on:mouseleave="clearAbilityHover()" x-on:dragenter="abilityTableDragHoverId = ability.ability_id">
                                <td class="has-text-centered drag" @click.stop draggable="true" x-on:dragstart="startAbilitySwap"  x-on:dragover.prevent="swapAbilitiesHover" x-on:dragend="swapAbilities">&#9776;</td>
                                <td x-text="index + 1"></td>
                                <td x-text="ability.name"></td>
                                <td x-text="ability.tactic"></td>
                                <td x-text="ability.technique_name"></td>
                                <td>
                                    <template x-for="platform of getExecutorDetail('platforms', ability)">
                                        <a class="has-tooltip-arrow" x-bind:data-tooltip="platform">
                                            <span class="icon is-small"><i class="fab" x-bind:class="if (platform.includes('windows')) return 'fa-windows'; else if (platform.includes('darwin')) return 'fa-apple'; else if (platform.includes('linux')) return 'fa-linux'"></i></span>
                                        </a>
                                    </template>
                                </td>
                                <td class="has-text-centered" x-bind:class="{ 'unlock': onHoverUnlocks.indexOf(ability.ability_id) > -1 }">
                                    <a class=" has-tooltip-arrow" x-show="getExecutorDetail('requirements', ability)" x-bind:data-tooltip="`This ability has requirements: (${abilityDependencies[ability.ability_id].requireTypes})`">
                                        <span class="icon is-small"><i class="fas fa-lock"></i></span>
                                    </a>
                                </td>
                                <td class="has-text-centered" x-bind:class="{ 'lock': onHoverLocks.indexOf(ability.ability_id) > -1 }">
                                    <a class="has-tooltip-arrow" x-show="getExecutorDetail('parser', ability)" x-bind:data-tooltip="`This ability unlocks other abilities: (${abilityDependencies[ability.ability_id].enableTypes})`">
                                        <span class="icon is-small"><i class="fas fa-key"></i></span>
                                    </a>
                                </td>
                                <td class="has-text-centered">
                                    <a class="has-tooltip-arrow" x-show="getExecutorDetail('payload', ability)" data-tooltip="This ability uses a payload">
                                        <span class="icon is-small"><i class="fas fa-weight-hanging"></i></span>
                                    </a> 
                                </td>
                                <td class="has-text-centered">
                                    <a class="has-tooltip-arrow" x-show="getExecutorDetail('cleanup', ability)" data-tooltip="This ability can clean itself up">
                                        <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                    </a>
                                </td>
                                <td class="has-text-centered"><button class="delete is-danger" @click.stop="removeAbility(index)"></button></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </template>
            <div class="icon-text" x-show="!hasMetAbilityDependencies()">
                <span class="icon has-text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </span>
                <span>One or more of the abilities have unmet requirements, which may result in a failed operation if ran sequentially.</span>
            </div>
        </div>
    </template>

    <!-- CREATE PROFILE SECTION -->

    <template x-if="isCreatingProfile">
        <div class="section content">
            <h3>Create a profile</h3>
            <form>
                <div class="field">
                    <label class="label is-small">Profile Name</label>
                    <div class="control">
                        <input x-model="createProfileName" class="input is-small" type="text" placeholder="Enter a name...">
                    </div>
                    <p class="help is-danger has-text-weight-bold" x-show="createProfileNameError" x-text="createProfileNameError"></p>
                </div>
                <div class="field">
                    <label class="label is-small">Profile Description</label>
                    <div class="control">
                        <input x-model="createProfileDescription" class="input is-small" type="text" placeholder="Enter a description...">
                    </div>
                    <p class="help is-danger has-text-weight-bold" x-show="createProfileDescriptionError" x-text="createProfileDescriptionError"></p>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <a class="button is-primary is-small" @click="createProfile()">Create</a>
                    </div>
                    <div class="control">
                        <a class="button is-small" @click="cancelCreateProfile()">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
    </template>

    <!-- MODALS -->

    <div class="modal" x-bind:class="{ 'is-active': showAddAdversaryModal }">
        <div class="modal-background" @click="showAddAdversaryModal = false; selectedAddAdversary = ''; abilitiesAddAdversary = [];"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Add Ablities from Adversary</p>
            </header>
            <section class="modal-card-body">
                <p>Select an adversary, then select all of the abilities you'd like to append to <b x-text="selectedProfileName"></b>.</p>
                <form>
                    <div class="field">
                        <label class="label">Select a profile</label>
                        <div class="control is-expanded">
                            <div class="select is-small">
                                <select x-on:change="loadProfileAdversary()" x-model="selectedAddAdversary">
                                    <option value="" default selected>Chose one...</option>
                                    {% for adv in adversaries %}
                                    <option value="{{ adv.adversary_id }}">{{ adv.name }}</option>
                                    <option disabled style="font-style:italic">&nbsp;&nbsp;&nbsp;{{ adv.description }}</option> 
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field" x-show="selectedAddAdversary">
                        <div class="control">
                            <a @click="abilitiesAddAdversary.forEach(a => a.selected = true)">Select All</a> 
                            / 
                            <a @click="abilitiesAddAdversary.forEach(a => a.selected = false)">Deselect All</a>
                        </div>
                    </div>
                    <template x-for="ability of abilitiesAddAdversary">
                        <div class="field">
                            <label class="checkbox">
                                <input type="checkbox" x-model="ability.selected"> 
                                <span>
                                    <b x-text="ability.name"></b> | 
                                    <span x-text="ability.tactic"></span> |
                                    <template x-for="platform of getExecutorDetail('platforms', ability)">
                                        <span class="icon is-small"><i class="fab" x-bind:class="if (platform.includes('windows')) return 'fa-windows'; else if (platform.includes('darwin')) return 'fa-apple'; else if (platform.includes('linux')) return 'fa-linux'"></i></span>
                                    </template> |
                                    <span class="icon is-small" x-show="getExecutorDetail('requirements', ability)"><i class="fas fa-lock"></i></span>
                                    <span class="icon is-small" x-show="getExecutorDetail('cleanup', ability)"><i class="fas fa-trash"></i></span>
                                    <span class="icon is-small" x-show="getExecutorDetail('parser', ability)"><i class="fas fa-key"></i></span>
                                    <span class="icon is-small" x-show="getExecutorDetail('payload', ability)"><i class="fas fa-weight-hanging"></i></span>
                                </span>
                            </label>
                        </div>
                    </template>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary is-small" x-bind:disabled="!abilitiesAddAdversary.find(a => a.selected)" @click="addAbilitiesFromAdversary()">Add Selected Abilities</button>
                <button class="button is-small" @click="showAddAdversaryModal = false; selectedAddAdversary = ''; abilitiesAddAdversary = [];">Cancel</button>
            </footer>
        </div>
    </div>

    <div class="modal" x-bind:class="{ 'is-active': showObjectiveModal }">
        <div class="modal-background" @click="showObjectiveModal = false"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Link Objective</p>
            </header>
            <section class="modal-card-body">
                <p>Specify an Objective for <b x-text="selectedProfileName"></b>.</p>
                <form>
                    <div class="field">
                        <label class="label">Select an objective</label>
                        <div class="control is-expanded">
                            <div class="select is-small">
                                <select x-model="selectedObjective.id">
                                    <option value="" default selected>Chose one...</option>
                                    {% for obj in objectives %}
                                    <option value="{{ obj.id }}">{{ obj.name }}</option>
                                    <option disabled style="font-style:italic">&nbsp;&nbsp;&nbsp;{{ obj.description }}</option> 
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary is-small" @click="toast('Objective changed', true); showObjectiveModal = false;">Link Objective</button>
                <button class="button is-small" @click="showObjectiveModal = false">Cancel</button>
            </footer>
        </div>
    </div>

    <div class="modal" x-bind:class="{ 'is-active': showAbilityModal }"> 
        <div class="modal-background" @click="showAbilityModal = false"></div>
        <div class="modal-card wide">
            <header class="modal-card-head">
                <p class="modal-card-title">Add an Ability to Adversary</p>
            </header>
            <section class="modal-card-body">
                <p class="has-text-centered">Select an Ability</p>
                <form>
                    <div class="field is-horizontal">
                        <div class="field-label is-small">
                            <label class="label"><span class="icon is-small"><i class="fas fa-search"></i></span></label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input is-small" x-model="abilitySearchQuery" placeholder="Search for an ability..." x-on:keyup="searchForAbility()">
                                    <div class="search-results">
                                        <template x-for="result of abilitySearchResults" :key="result.ability_id">
                                            <p @click="selectAbility(result.ability_id)" x-text="result.name"></p>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form>
                    <div class="field is-horizontal">
                        <div class="field-label is-small">
                            <label class="label">Tactic</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select x-model="selectedTactic" x-on:change="selectedAbilityId = ''">
                                            <option default>Choose a tactic</option>
                                            <template x-for="tactic of [...new Set(exploits.map((e) => e.tactic))]" :key="tactic">
                                                <option x-bind:value="tactic" x-text="tactic"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-small">
                            <label class="label">Technique</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select x-model="selectedTechnique" x-bind:disabled="!selectedTactic" x-on:change="selectedAbilityId = ''">
                                            <option default>Choose a technique</option>
                                            <template :key="exploit.technique_id" x-for="exploit of [...new Set(exploits.filter((e) => selectedTactic === e.tactic).map((e) => e.technique_id))].map((t) => exploits.find((e) => e.technique_id === t))">
                                                <option x-bind:value="exploit.technique_id" x-text="`${exploit.technique_id} | ${exploit.technique_name}`"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal is-fullwidth">
                        <div class="field-label is-small">
                            <label class="label">Ability</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select x-model="selectedAbilityId" x-bind:disabled="!selectedTechnique" x-on:change="selectAbility(selectedAbilityId)">
                                            <option default>Choose an ability</option>
                                            <template :key="exploit.ability_id" x-for="exploit of exploits.filter((e) => selectedTactic === e.tactic && selectedTechnique === e.technique_id)">
                                                <option x-bind:value="exploit.ability_id" x-text="exploit.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <template x-if="selectedAbilityId">
                    <div class="content">
                        <hr>
                        <p class="has-text-centered">Ability Details</p>
                        <form>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">ID</label>
                                </div>
                                <div class="field-body">
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <input class="input is-small" x-model="selectedAbility.ability_id" disabled>
                                        </div>
                                        <div class="control">
                                            <a class="button is-small has-tooltip-left has-tooltip-arrow" data-tooltip="Generate New ID" @click="selectedAbility.ability_id = uuidv4()">
                                                <span class="icon is-small"><i class="fas fa-sync"></i></span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Name</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.name">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Description</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.description">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Tactic</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.tactic">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label is-small">Technique ID</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.technique_id">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label">Technique Name</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input is-small" x-model="selectedAbility.technique_name">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <p class="has-text-centered">Executors</p>
                        <div class="has-text-centered">
                            <button class="button is-small is-primary" @click="addExecutorToAbility('before')">+ Add Executor</button>
                        </div>
                        <br>
                        <template x-for="(executor, index) of selectedAbility.executors">
                            <div class="box">
                                <div class="has-text-right">
                                    <button class="delete" @click="selectedAbility.executors.splice(index, 1)"></button>
                                </div>
                                <form>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">platform</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <div class="select is-small">
                                                        <select x-model="executor.platform">
                                                            <template x-for="platform of Object.keys(platforms)">
                                                                <option x-bind:value="platform" x-text="platform"></option>
                                                            </template>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">executor</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <div class="select is-small">
                                                        <select x-model="executor.name">
                                                            <option default disabled>Select an executor...</option>
                                                            <template x-for="executor of platforms[executor.platform]">
                                                                <option x-bind:value="executor" x-text="executor"></option>
                                                            </template>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">payloads</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field is-grouped is-grouped-multiline">
                                                <p x-show="executor.payloads.length === 0" class="help">No payloads selected</p>
                                                <template x-for="(payload, index) of executor.payloads">
                                                    <div class="control">
                                                        <div class="tags has-addons">
                                                            <span class="tag is-small is-link" x-text="payload"></span>
                                                            <a class="tag is-delete" x-on:click="executor.payloads.splice(index, 1)"></a>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label"></label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field">
                                                <div class="control">
                                                    <div class="select is-small is-multiple is-fullwidth">
                                                        <select class="select" multiple size="6">
                                                            <template x-for="payload of payloads">
                                                                <option x-show="executor.payloads.indexOf(payload) === -1" x-on:click="executor.payloads.push(payload)" x-text="payload"></option>
                                                            </template>      
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">command</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <textarea class="textarea is-small code" x-model="executor.command"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">timeout</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <input class="input is-small" type="number" x-model="executor.timeout">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field is-horizontal">
                                        <div class="field-label is-small">
                                            <label class="label">cleanup</label>
                                        </div>
                                        <div class="field-body">
                                            <div class="field ">
                                                <div class="control">
                                                    <input class="input is-small code" x-model="executor.cleanup">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </template>
                        <template x-if="selectedAbility.executors.length > 0">
                            <div class="has-text-centered">
                                <button class="button is-small is-primary" @click="addExecutorToAbility('after')">+ Add Executor</button>
                            </div>
                        </template>
                    </div>
                </template>
            </section>
            <footer class="modal-card-foot">
                <nav class="level">
                    <div class="level-left">
                        <div class="level-item" x-show="selectedAbility">
                            <button class="button is-primary is-small" @click="saveAbility(true); showAbilityModal = false;">Add to Adversary</button>
                        </div>
                        <div class="level-item" x-show="selectedAbility">
                            <button class="button is-small" @click="saveAbility(false)">Save</button>
                        </div>
                    </div>
                    <div class="level-right">
                        <p class="level-item">
                            <button class="button is-small" @click="showAbilityModal = false">Close</button>
                        </p>
                    </div>
                </nav>
            </footer>
        </div>
    </div>

</div>

<script>
    // Jinja variables
    let adversaries = {{ adversaries | tojson }};
    let objectives = {{ objectives | tojson }};
    let exploits = {{ exploits | tojson }};
    let platforms = {{ platforms | tojson }};
    let payloads = {{ payloads | tojson }};

    function alpineAdversaries() {
        return {
            // Global page variables
            selectedProfile: '',
            selectedProfileName: '',
            selectedProfileDescription: '',
            adversaries: [],
            abilities: [],
            objectives: [],
            platforms: platforms,
            exploits: exploits,

            // Ability dependencies & parsers
            abilityDependencies: {},
            needsParser: [],
            onHoverUnlocks: [],
            onHoverLocks: [],

            // Create a profile
            isEdittingProfile: false,
            isCreatingProfile: false,
            createProfileNameError: false,
            createProfileDescriptionError: false,
            createProfileName: '',
            createProfileDescription: '',

            // Table on drag and drop
            abilityTableDragTarget: undefined,
            abilityTableDragEndIndex: undefined,
            abilityTableDragHoverId: undefined,

            unsavedChanges: false,

            // Add adversary modal
            showAddAdversaryModal: false,
            selectedAddAdversary: '',
            abilitiesAddAdversary: [],

            // Objective modal
            showObjectiveModal: false,
            selectedObjective: {},

            // Ability modal
            showAbilityModal: false,
            selectedTactic: '',
            selectedTechnique: '',
            selectedAbilityId: '',
            abilitySearchQuery: '',
            abilitySearchResults: [],
            selectedAbility: {},
            selectedPlatform: '',
            selectedExecutor: '',

            getExecutorDetail(detail, ability) {
                let executorNameMap = new Map([
                    ['psh', 'powershell'],
                    ['pwsh', 'powershell core'],
                    ['sh', 'shell'],
                    ['cmd', 'commandline'],
                ]);
                let platforms = [], hasCleanup = false, hasPayload = false, hasParser = false;

                ability.executors.forEach((executor) => {
                    if (executor.cleanup.length > 0) hasCleanup = true;
                    if (executor.parsers.length > 0) hasParser = true;
                    if (executor.payloads.length > 0) hasPayload = true;
                    platforms.push(`${executor.platform} (${executorNameMap.get(executor.name) || executor.name})`);
                });

                switch (detail) {
                    case 'cleanup':
                        return hasCleanup;
                    case 'parser':
                        return hasParser;
                    case 'payload':
                        return hasPayload;
                    case 'requirements':
                        return ability.requirements.length > 0;
                    case 'platforms':
                        return platforms;
                    default:
                        return false;
                }
            },

            findAbilityDependencies() {
                let types = {};

                this.abilities.forEach((ability, index) => {
                    let requireTypes = [], enableTypes = [];

                    // Get all parser types from executors
                    ability.executors.forEach((executor) => {
                        executor.parsers.map((parser) => {
                            enableTypes = enableTypes.concat(parser.relationships.map((rel) => rel.source));
                        });
                    });
                    
                    // Get all requirement types
                    ability.requirements.forEach((requirement) => {
                        requireTypes = requireTypes.concat(requirement.relationship_match.map((match) => match.source));
                    });

                    types[ability.ability_id] = {  
                        enableTypes: [...new Set(enableTypes)],
                        requireTypes: [...new Set(requireTypes)]
                    };
                });

                this.abilities.forEach((ability, index) => {
                    let enablesAbilityIds = [], requiresAbilityIds = [], requireTypesMet = [];
                    // For each parser, look at and forward for any ability it unlocks
                    types[ability.ability_id].enableTypes.forEach((key) => {
                        for (let i = index; i < this.abilities.length; i++) {
                            if (types[this.abilities[i].ability_id].requireTypes.indexOf(key) > -1) {
                                enablesAbilityIds.push(this.abilities[i].ability_id);
                            }
                        }
                    });

                    // For each requirement, look at and before for any ability to unlock it
                    types[ability.ability_id].requireTypes.forEach((requirement) => {
                        let requirementMet = false;
                        for (let i = index; i >= 0; i--) {
                            if (types[this.abilities[i].ability_id].enableTypes.indexOf(requirement) > -1) {
                                requiresAbilityIds.push(this.abilities[i].ability_id);
                                requirementMet = true;
                            }
                        }
                        requireTypesMet.push(requirementMet);
                    });

                    this.abilityDependencies[ability.ability_id] = {
                        enablesAbilityIds: [...new Set(enablesAbilityIds)],  // The ability IDs that this ability will enable
                        requiresAbilityIds: [...new Set(requiresAbilityIds)],  // The ability IDs that this ability is dependent on
                        enableTypes: types[ability.ability_id].enableTypes,  // The names of the parser requirements this ability enables
                        requireTypes: types[ability.ability_id].requireTypes,  // The names of the requirements this ability needs from a parser
                        requireTypesMet: requireTypesMet  // Same dimension as requireTypes, but true/false if requirement has been met
                    }
                });

                this.hasMetAbilityDependencies();
            },

            hasMetAbilityDependencies() {
                let keys = [], isMet = true;
                this.needsParser = [];

                Object.keys(this.abilityDependencies).forEach((abilityId) => {
                    if (!this.abilityDependencies[abilityId].requireTypesMet.every(((requirement) => requirement))) {
                        isMet = false;
                        try {
                            this.needsParser.push(this.abilities.find((ability) => ability.ability_id === abilityId).name);
                        } catch {}
                    }
                });

                return isMet;
            },

            setAbilityHover(abilityId) {
                this.onHoverLocks = this.abilityDependencies[abilityId].requiresAbilityIds;
                this.onHoverUnlocks = this.abilityDependencies[abilityId].enablesAbilityIds;
                if (this.abilityDependencies[abilityId].requireTypes.length) this.onHoverUnlocks.push(abilityId);
                if (this.abilityDependencies[abilityId].enableTypes.length) this.onHoverLocks.push(abilityId);
            },

            clearAbilityHover() {
                this.onHoverLocks = [];
                this.onHoverUnlocks = [];
            },

            loadProfile() {
                if (!this.selectedProfile) return;

                this.abilities = [];
                this.isCreatingProfile = false;

                apiRequest('POST', { 'index': 'adversaries', 'adversary_id': this.selectedProfile }).then((data) => {
                    data = JSON.parse(data)[0]

                    this.selectedProfileName = data.name;
                    this.selectedProfileDescription = data.description;
                    this.selectedObjective = data.objective;
                    
                    this.abilities = data.atomic_ordering;
                    this.findAbilityDependencies();
                }).catch((error) => {
                    toast('Error loading profile', false);
                    console.error(error);
                });
            },

            loadProfileAdversary() {
                if (!this.selectedAddAdversary) return;

                this.abilitiesAddAdversary = [];

                apiRequest('POST', { 'index': 'adversaries', 'adversary_id': this.selectedAddAdversary }).then((data) => {
                    data = JSON.parse(data)[0]
                    
                    data.atomic_ordering.forEach((ability) => {
                        this.abilitiesAddAdversary.push({
                            ...ability,
                            selected: true
                        });
                    });
                }).catch((error) => {
                    toast('Error loading adversary profile', false);
                    console.error(error);
                });
            },

            createProfile() {
                // Verify user input
                this.createProfileNameError = '';
                this.createProfileDescriptionError = '';
                if (this.createProfileName.length === 0) {
                    this.createProfileNameError = 'You must enter a profile name';
                    return;
                } else if (adversaries.map(a => a.name).indexOf(this.createProfileName) > -1) {
                    this.createProfileNameError = 'Profile name already exists';
                    return;
                } else if (this.createProfileDescription.length === 0) {
                    this.createProfileDescriptionError = 'You must enter a profile description';
                    return;
                }

                let requestBody = {
                    "name": this.createProfileName,
                    "description": this.createProfileDescription,
                    "atomic_ordering": [],
                    "index": "adversaries",
                    'id': uuidv4(),
                    "objective": objectives.find((o) => o.name === 'default').id
                }

                apiRequest('PUT', requestBody).then((data) => {
                    data = JSON.parse(data)[0]
                    adversaries.push(data);
                    this.selectedProfile = data.adversary_id;
                    this.loadProfile();
                    this.isCreatingProfile = false;
                    toast('Created profile!', true);
                }).catch((error) => {
                    toast('Error creating profile', false);
                    console.error(error);
                });
            },

            cancelCreateProfile() {
                this.createProfileName = '';
                this.createProfileDescription = '';
                this.isCreatingProfile = false;
            },

            saveProfile() {
                let atomicOrdering = [];
                this.abilities.forEach((a) => atomicOrdering.push({ 'id': a.ability_id }));

                let requestBody = {
                    "name": this.selectedProfileName,
                    "description": this.selectedProfileDescription,
                    "atomic_ordering": atomicOrdering,
                    "index": "adversaries",
                    "id": this.selectedProfile,
                    "objective": "495a9828-cab1-44dd-a0ca-66e58177d8cc"
                }

                apiRequest('PUT', requestBody).then((data) => {
                    this.unsavedChanges = false;
                    toast('Saved profile!', true);
                }).catch((error) => {
                    toast('Error saving profile', false);
                    console.error(error);
                });
            },

            deleteProfile() {
                if (confirm('Are you sure you want to remove this adversary?')) {
                    apiRequest('DELETE', { 'index': 'adversaries', 'adversary_id': this.selectedProfile }).then((data) => {
                        adversaries.splice(adversaries.findIndex(a => a.adversary_id === this.selectedProfile), 1);
                        this.selectedProfile = null;
                        toast('Adversary profile deleted.', true);
                    }).catch((error => {
                        toast('Error deleting profile', false);
                        console.error(error);
                    }));
                }
            },

            addAbilitiesFromAdversary() {
                let selectedAbilities = this.abilitiesAddAdversary.filter((a) => a.selected);
                this.abilities = this.abilities.concat(selectedAbilities);
                this.showAddAdversaryModal = false;
                this.selectedAddAdversary = '';
                this.abilitiesAddAdversary = [];
                this.unsavedChanges = true;
            },

            addExecutorToAbility(bOrA) {
                let template = {
                    payloads: [],
                    platform: Object.keys(this.platforms)[0]
                };

                if (bOrA === 'after') {
                    this.selectedAbility.executors.push(template);
                } else if (bOrA === 'before') {
                    this.selectedAbility.executors.unshift(template);
                }
            },

            searchForAbility() {
                this.abilitySearchResults = [];
                if (!this.abilitySearchQuery) return;
                this.exploits.forEach((exploit) => {
                    if (exploit.name.toLowerCase().indexOf(this.abilitySearchQuery.toLowerCase()) > -1) {
                        this.abilitySearchResults.push({
                            ability_id: exploit.ability_id,
                            name: exploit.name
                        });
                    }
                });
            },

            selectAbility(id) {
                this.abilitySearchQuery = [];
                this.abilitySearchResults = [];
                this.selectedAbility = {};
                this.selectedAbility = exploits.find((exploit) => exploit.ability_id === id);
                this.selectedTactic = this.selectedAbility.tactic;
                this.selectedTechnique = this.selectedAbility.technique_id;
                this.selectedAbilityId = id;
                this.showAbilityModal = true;
            },

            saveAbility(addToAdversary) {
                let platforms = {};
                this.selectedAbility.executors.forEach((executor) => {
                    if (!platforms[executor.platform]) {
                        platforms[executor.platform] = {}
                    }

                    platforms[executor.platform][executor.name] = {
                        'payloads': [...executor.payloads],
                        'command': executor.command.toString(),
                        'timeout': executor.timeout.toString(),
                        'cleanup': executor.cleanup.toString()
                    }
                });

                let requestBody = {
                    'index': 'abilities',
                    'id': this.selectedAbility.ability_id,
                    'name': this.selectedAbility.name,
                    'description': this.selectedAbility.description,
                    'tactic': this.selectedAbility.tactic,
                    'technique': {
                        'attack_id': this.selectedAbility.technique_id,
                        'name': this.selectedAbility.technique_name
                    },
                    'platforms': platforms
                }

                apiRequest('PUT', requestBody).then((response) => {
                    toast('Saved ability!', true);

                    // Apply these changes to all matching abilites so we don't need to make another REST request
                    this.abilities.forEach((ability, index, arr) => {
                        if (ability.ability_id === this.selectedAbilityId) {
                            arr[index] = this.selectedAbility;
                        }
                    });
                    this.exploits = exploits;

                    if (addToAdversary) {
                        this.abilities.push(this.selectedAbility);
                        this.unsavedChanges = true;
                        this.selectedAbility = {};
                        this.selectedAbilityId = '';
                    }
                }).catch((error) => {
                    toast('Error saving ability', false);
                    console.error(error);
                });
            },

            removeAbility(index) {
                this.abilities.splice(index, 1);
                this.unsavedChanges = true;
            },

            startAbilitySwap(event) {
                this.abilityTableDragTarget = event.target.parentNode;
            },

            swapAbilitiesHover(event) {
                let children = Array.from(event.target.parentNode.parentNode.children);

                if (children.indexOf(event.target.parentNode) > children.indexOf(this.abilityTableDragTarget)) {
                    this.abilityTableDragEndIndex = parseInt(event.target.parentNode.children[1].innerHTML);
                } else {
                    this.abilityTableDragEndIndex = parseInt(event.target.parentNode.children[1].innerHTML);
                }
            },

            swapAbilities(event) {
                let fromIndex = parseInt(this.abilityTableDragTarget.children[1].innerHTML) - 1;
                let toIndex = this.abilityTableDragEndIndex - 1;
                let temp = this.abilities[fromIndex];
                this.abilities[fromIndex] = this.abilities[toIndex];
                this.abilities[toIndex] = temp;

                this.unsavedChanges = true;
                this.abilityTableDragHoverId = undefined;
                this.abilityTableDragEndIndex = undefined
            },

        };
    }

    // # sourceURL=adversaries.js
</script>

<style>
    td {
        cursor: pointer;
    }

    th {
        border: 0 !important;
    }

    #select-adversary {
        max-width: 800px;
        margin: 0 auto;
    }

    .code {
        font-family: monospace;
    }

    .control-buttons>.button {
        margin: 0 10px 10px 0;
    }

    .drag {
        cursor: grab;
    }

    .level {
        width: 100%;
    }

    .lock {
        background-color: blueviolet !important;
    }

    .pointer {
        cursor: pointer;
    }

    .red-row {
        border: 2px solid #8B0000;
    }

    .row-hover {
        background-color: #484848 !important;
    }

    .search-results {
        overflow-y: scroll;
        max-height: 200px;
        background-color: #010101;
        border-radius: 0 4px;
    }
    .search-results p {
        margin-bottom: 0 !important;
        padding: 5px;
        cursor: pointer;
    }
    .search-results p:hover {
        background-color: #484848;
    }

    .unlock {
        background-color: coral !important;
    }

    .vr {
        width: 1px;
        height: 30px;
        margin: 0 20px 0 10px;
        background-color: grey;
    }
</style>
